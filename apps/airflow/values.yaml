airflow:
  image:
    repository: apache/airflow
    tag: "2.9.3"

  executor: "KubernetesExecutor"

  config:
    # Base config
    AIRFLOW__WEBSERVER__BASE_URL: "https://airflow.bergtobias.com"
    AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX: "True"
    AIRFLOW__KUBERNETES__NAMESPACE: "airflow"
    AIRFLOW__KUBERNETES__DELETE_WORKER_PODS: "True"
    AIRFLOW__KUBERNETES__DELETE_WORKER_PODS_ON_FAILURE: "True"
    AIRFLOW__KUBERNETES__DAGS_IN_IMAGE: "False"

    # Enable new auth_manager (FabAuthManager)
    AIRFLOW__WEBSERVER__AUTH_BACKEND: "airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager"

  extraEnv:
    - name: AIRFLOW__FAB_AUTH_MANAGER__OAUTH_PROVIDERS
      value: |
        [
          {
            "name": "github",
            "icon": "fa-github",
            "token_key": "access_token",
            "remote_app": {
              "client_id": "${GITHUB_CLIENT_ID}",
              "client_secret": "${GITHUB_CLIENT_SECRET}",
              "api_base_url": "https://api.github.com",
              "client_kwargs": {"scope": "read:user, read:org"},
              "access_token_url": "https://github.com/login/oauth/access_token",
              "authorize_url": "https://github.com/login/oauth/authorize",
              "request_token_url": null
            }
          }
        ]
    - name: AIRFLOW__FAB_AUTH_MANAGER__SECURITY_MANAGER_CLASS
      value: security_manager.override.CustomSecurityManager
    - name: GITHUB_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: github-airflow-oauth
          key: client-id
    - name: GITHUB_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: github-airflow-oauth
          key: client-secret

  # Mount your override.py for role mapping
  extraVolumeMounts:
    - name: security-manager
      mountPath: /opt/airflow/config/security_manager
      readOnly: true

  extraVolumes:
    - name: security-manager
      configMap:
        name: airflow-security-manager

  web:
    replicas: 1

  dags:
    gitSync:
      enabled: true
      repo: https://github.com/vercevo/dags
      branch: main
      rev: HEAD
      depth: 1
      subPath: ""
      wait: 60

  redis:
    enabled: false
  flower:
    enabled: false
  workers:
    enabled: false
